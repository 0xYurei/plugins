(function(n,p,E,S){"use strict";function g(d){return d&&typeof d=="object"&&"default"in d?d:{default:d}}var m=g(p),o=g(E);class _{constructor(){this.patches=[]}add(...r){this.patches.push(...r)}remove(r){let[i]=this.patches.splice(this.patches.indexOf(u=>u==r),1);i()}removeAll(){let r=this.patches.splice(0,this.patches.length);for(let i=0;i<r.length;i++)r[i]()}}var c=new _,H=()=>S.injectCSS(".amd--edited-message{background-color:#1efa1a1a}.amd--deleted-message{background-color:#f047471a}"),M={async load(){await new Promise(e=>setTimeout(e,1e3));let d=[];c.add(H());function r(e,s){return n.MessageStore.__getLocalVars().rawMessages?.[e]?.[s]}function i(e,s=!0){let a=d.find(t=>t.messageId==e);return a||(a={deleted:!1,messageId:e,edits:[]},s&&d.push(a)),a}function u(e){if(!e?.id?.startsWith("chat-messages-")||e.antiMessageDeletionUpdate)return;let s=e.id.split("-").pop();e.antiMessageDeletionUpdate=()=>{let a=i(s,!1);a.deleted&&e.classList.add("amd--deleted-message"),a.content&&(e.classList.add("amd--edited-message"),o.default.ifExists(e.querySelector(`#message-content-${s}`),t=>{t.innerHTML=`${a.edits.map(l=>n.SimpleMarkdown.markdownToHtml(`${l} *(edited)*`)).join("")}${n.SimpleMarkdown.markdownToHtml(`${a.content} *(original)*`)}`}))},e.antiMessageDeletionUpdate()}for(c.add(m.default.patch('[id*="chat-messages-"]',u));!n.FluxDispatcher?._actionHandlers?._orderedActionHandlers?.MESSAGE_DELETE?.find?.(e=>e?.name=="MessageStore");)await new o.default.sleep(50);for(c.add((()=>{let e=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(t=>t.name=="MessageStore"),s=e.actionHandler,a=e.storeDidChange;return e.actionHandler=t=>{!t?.id||t?.author?.bot||(i(t.id,!0).deleted=!0,setTimeout(()=>{o.default.ifExists(document.querySelector(`#chat-messages-${t?.id}`),u)},100))},e.storeDidChange=()=>{},()=>{d=[];let t=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(l=>l.name=="MessageStore");t.actionHandler=s,t.storeDidChange=a}})());!n.FluxDispatcher?._actionHandlers?._orderedActionHandlers?.MESSAGE_DELETE?.find?.(e=>e?.name=="MessageStore");)await new o.default.sleep(50);c.add((()=>{let e=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_UPDATE.find(t=>t.name=="MessageStore"),s=e.actionHandler,a=e.storeDidChange;return e.actionHandler=function(t){if(!t?.message?.id||t?.message?.author?.bot)return;if(t.message.content){let h=r(t.message.channel_id,t.message.id);if(h){let f=i(h.id,!0);f.edits.length||(f.content=h.content),f.content!=t.message.content&&f.edits.push(t.message.content)}}let l=s.call(this,t);return setTimeout(()=>{o.default.ifExists(document.querySelector(`#chat-messages-${t.message.id}`),u)},100),l},()=>{let t=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(l=>l.name=="MessageStore");t.actionHandler=s,t.storeDidChange=a}})())},unload(){c.removeAll()}};return M})(acord.modules.common,acord.dom,acord.utils,acord.patcher);
