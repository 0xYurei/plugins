(function(r,p,m,S){"use strict";function g(i){return i&&typeof i=="object"&&"default"in i?i:{default:i}}var E=g(p),u=g(m);class H{constructor(){this.patches=[]}add(...d){this.patches.push(...d)}remove(d){let[n]=this.patches.splice(this.patches.indexOf(t=>t==d),1);n()}removeAll(){let d=this.patches.splice(0,this.patches.length);for(let n=0;n<d.length;n++)d[n]()}}var o=new H,M=()=>S.injectCSS(".amd--edited-message{background-color:#1efa1a1a}.amd--deleted-message{background-color:#f047471a}");let h=[];var D={load(){o.add(M());function i(t,s){return r.MessageStore.__getLocalVars().rawMessages?.[t]?.[s]}function d(t,s=!0){let a=h.find(e=>e.messageId==t);return a||(a={deleted:!1,messageId:t,edits:[]},s&&h.push(a)),a}function n(t){if(!t?.id?.startsWith("chat-messages-")||t.antiMessageDeletionUpdate)return;let s=t.id.split("-").pop();t.antiMessageDeletionUpdate=()=>{let a=d(s,!1);a.deleted&&t.classList.add("amd--deleted-message"),a.content&&(t.classList.add("amd--edited-message"),u.default.ifExists(t.querySelector(`#message-content-${s}`),e=>{e.innerHTML=`${a.edits.map(l=>r.SimpleMarkdown.markdownToHtml(`${l} *(edited)*`)).join("")}${r.SimpleMarkdown.markdownToHtml(`${a.content} *(original)*`)}`}))},t.antiMessageDeletionUpdate()}o.add(E.default.patch('[id*="chat-messages-"]',n)),o.add((()=>{let t=r.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(e=>e.name=="MessageStore"),s=t.actionHandler,a=t.storeDidChange;return t.actionHandler=e=>{!e?.id||e?.author?.bot||(d(e.id,!0).deleted=!0,u.default.ifExists(document.querySelector(`#chat-messages-${e?.id}`),n))},t.storeDidChange=()=>{},()=>{h=[];let e=r.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(l=>l.name=="MessageStore");e.actionHandler=s,e.storeDidChange=a}})()),o.add((()=>{let t=r.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_UPDATE.find(e=>e.name=="MessageStore"),s=t.actionHandler,a=t.storeDidChange;return t.actionHandler=function(e){if(!e?.message?.id||e?.message?.author?.bot)return;if(e.message.content){let f=i(e.message.channel_id,e.message.id);if(f){let c=d(f.id,!0);c.edits.length||(c.content=f.content),c.content!=e.message.content&&c.edits.push(e.message.content)}}let l=s.call(this,e);return u.default.ifExists(document.querySelector(`#chat-messages-${e.message.id}`),n),l},()=>{let e=r.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(l=>l.name=="MessageStore");e.actionHandler=s,e.storeDidChange=a}})())},unload(){o.removeAll()}};return D})(acord.modules.common,acord.dom,acord.utils,acord.patcher);
