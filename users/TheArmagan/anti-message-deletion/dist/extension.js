(function(n,p,E,S){"use strict";function g(d){return d&&typeof d=="object"&&"default"in d?d:{default:d}}var _=g(p),o=g(E);class H{constructor(){this.patches=[]}add(...r){this.patches.push(...r)}remove(r){let[i]=this.patches.splice(this.patches.indexOf(u=>u==r),1);i()}removeAll(){let r=this.patches.splice(0,this.patches.length);for(let i=0;i<r.length;i++)r[i]()}}var c=new H,M=()=>S.injectCSS(".amd--edited-message{background-color:#1efa1a1a}.amd--deleted-message{background-color:#f047471a}"),D={async load(){let d=[];c.add(M());function r(t,s){return n.MessageStore.__getLocalVars().rawMessages?.[t]?.[s]}function i(t,s=!0){let a=d.find(e=>e.messageId==t);return a||(a={deleted:!1,messageId:t,edits:[]},s&&d.push(a)),a}function u(t){if(!t?.id?.startsWith("chat-messages-")||t.antiMessageDeletionUpdate)return;let s=t.id.split("-").pop();t.antiMessageDeletionUpdate=()=>{let a=i(s,!1);a.deleted&&t.classList.add("amd--deleted-message"),a.content&&(t.classList.add("amd--edited-message"),o.default.ifExists(t.querySelector(`#message-content-${s}`),e=>{e.innerHTML=`${a.edits.map(l=>n.SimpleMarkdown.markdownToHtml(`${l} *(edited)*`)).join("")}${n.SimpleMarkdown.markdownToHtml(`${a.content} *(original)*`)}`}))},t.antiMessageDeletionUpdate()}for(c.add(_.default.patch('[id*="chat-messages-"]',u));!n.FluxDispatcher?._actionHandlers?._orderedActionHandlers?.MESSAGE_DELETE?.find?.(t=>t?.name=="MessageStore");)await new o.default.sleep(50);for(c.add((()=>{let t=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(e=>e.name=="MessageStore"),s=t.actionHandler,a=t.storeDidChange;return t.actionHandler=e=>{!e?.id||e?.author?.bot||(i(e.id,!0).deleted=!0,o.default.ifExists(document.querySelector(`#chat-messages-${e?.id}`),u))},t.storeDidChange=()=>{},()=>{d=[];let e=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(l=>l.name=="MessageStore");e.actionHandler=s,e.storeDidChange=a}})());!n.FluxDispatcher?._actionHandlers?._orderedActionHandlers?.MESSAGE_DELETE?.find?.(t=>t?.name=="MessageStore");)await new o.default.sleep(50);c.add((()=>{let t=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_UPDATE.find(e=>e.name=="MessageStore"),s=t.actionHandler,a=t.storeDidChange;return t.actionHandler=function(e){if(!e?.message?.id||e?.message?.author?.bot)return;if(e.message.content){let h=r(e.message.channel_id,e.message.id);if(h){let f=i(h.id,!0);f.edits.length||(f.content=h.content),f.content!=e.message.content&&f.edits.push(e.message.content)}}let l=s.call(this,e);return o.default.ifExists(document.querySelector(`#chat-messages-${e.message.id}`),u),l},()=>{let e=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(l=>l.name=="MessageStore");e.actionHandler=s,e.storeDidChange=a}})())},unload(){c.removeAll()}};return D})(acord.modules.common,acord.dom,acord.utils,acord.patcher);
