(function(n,S,m,p,D){"use strict";function E(i){return i&&typeof i=="object"&&"default"in i?i:{default:i}}var h=E(S),o=E(m);class _{constructor(){this.patches=[]}add(...d){this.patches.push(...d)}remove(d){let[r]=this.patches.splice(this.patches.indexOf(u=>u==d),1);r()}removeAll(){let d=this.patches.splice(0,this.patches.length);for(let r=0;r<d.length;r++)d[r]()}}var c=new _,H=()=>D.injectCSS(".amd--edited-message{background-color:#1efa1a1a}.amd--deleted-message{background-color:#f047471a}"),M={async load(){let i=[];c.add(H());function d(t,a){return n.MessageStore.__getLocalVars().rawMessages?.[t]?.[a]}function r(t,a=!0){let s=i.find(e=>e.messageId==t);return s||(s={deleted:!1,messageId:t,edits:[]},a&&i.push(s)),s}function u(t){if(!t?.id?.startsWith("chat-messages-")||t.antiMessageDeletionUpdate)return;let a=t?.id?.split("-")?.pop();!a||(t.antiMessageDeletionUpdate=()=>{let s=r(a,!1);s.deleted&&t.classList.add("amd--deleted-message"),s.content&&(t.classList.add("amd--edited-message"),o.default.ifExists(t.querySelector(`#message-content-${a}`),e=>{e.innerHTML=`${h.default.formatContent(`${s.content} *(original)*`)}<br/>${s.edits.map(l=>h.default.formatContent(`${l} *(edited)*`)).join("")}`}))},t.antiMessageDeletionUpdate())}for(c.add(h.default.patch('[id*="chat-messages-"]',u));!n.FluxDispatcher?._actionHandlers?._orderedActionHandlers?.MESSAGE_DELETE?.find?.(t=>t?.name=="MessageStore");)await new o.default.sleep(50);for(c.add((()=>{let t=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(e=>e.name=="MessageStore"),a=t.actionHandler,s=t.storeDidChange;return t.actionHandler=e=>{if(!p.persist.ghost.settings.antiDelete)return a.call(this,e);!e?.id||n.UserStore.getUser(d(e.channelId,e.id)?.author?.id)?.bot||(r(e.id,!0).deleted=!0,setTimeout(()=>{o.default.ifExists(document.querySelector(`#chat-messages-${e?.id}`),u)},100))},t.storeDidChange=()=>{},()=>{i=[];let e=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(l=>l.name=="MessageStore");e.actionHandler=a,e.storeDidChange=s}})());!n.FluxDispatcher?._actionHandlers?._orderedActionHandlers?.MESSAGE_UPDATE?.find?.(t=>t?.name=="MessageStore");)await new o.default.sleep(50);c.add((()=>{let t=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_UPDATE.find(e=>e.name=="MessageStore"),a=t.actionHandler,s=t.storeDidChange;return t.actionHandler=function(e){if(!p.persist.ghost.settings.antiEdit)return a.call(this,e);if(!e?.message?.id||!e?.message?.author?.id||n.UserStore.getUser(e?.message?.author?.id)?.bot)return;if(e.message.content){let g=d(e.message.channel_id,e.message.id);if(g){let f=r(g.id,!0);f.edits.length||(f.content=g.content),f.content!=e.message.content&&f.edits.push(e.message.content)}}let l=a.call(this,e);return setTimeout(()=>{o.default.ifExists(document.querySelector(`#chat-messages-${e.message.id}`),u)},100),l},()=>{let e=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(l=>l.name=="MessageStore");e.actionHandler=a,e.storeDidChange=s}})())},unload(){c.removeAll()},settings:{data:[{type:"checkbox",name:"Anti-Delete",property:"antiDelete",value:!0},{type:"checkbox",name:"Anti-Edit",property:"antiEdit",value:!1}]}};return M})(acord.modules.common,acord.dom,acord.utils,acord.extension,acord.patcher);
