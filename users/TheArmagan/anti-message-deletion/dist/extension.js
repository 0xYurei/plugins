(function(n,S,D,p,_){"use strict";function E(i){return i&&typeof i=="object"&&"default"in i?i:{default:i}}var f=E(S),o=E(D);class m{constructor(){this.patches=[]}add(...r){this.patches.push(...r)}remove(r){let[d]=this.patches.splice(this.patches.indexOf(u=>u==r),1);d()}removeAll(){let r=this.patches.splice(0,this.patches.length);for(let d=0;d<r.length;d++)r[d]()}}var c=new m,H=()=>_.injectCSS(".amd--edited-message{background-color:#1efa1a1a}.amd--deleted-message{background-color:#f047471a}"),M={async load(){await new Promise(t=>setTimeout(t,1e3));let i=[];c.add(H());function r(t,a){return n.MessageStore.__getLocalVars().rawMessages?.[t]?.[a]}function d(t,a=!0){let s=i.find(e=>e.messageId==t);return s||(s={deleted:!1,messageId:t,edits:[]},a&&i.push(s)),s}function u(t){if(!t?.id?.startsWith("chat-messages-")||t.antiMessageDeletionUpdate)return;let a=t.id.split("-").pop();t.antiMessageDeletionUpdate=()=>{let s=d(a,!1);s.deleted&&t.classList.add("amd--deleted-message"),s.content&&(t.classList.add("amd--edited-message"),o.default.ifExists(t.querySelector(`#message-content-${a}`),e=>{e.innerHTML=`${f.default.formatContent(`${s.content} *(original)*`)}${s.edits.map(l=>f.default.formatContent(`${l} *(edited)*`)).join("")}`}))},t.antiMessageDeletionUpdate()}for(c.add(f.default.patch('[id*="chat-messages-"]',u));!n.FluxDispatcher?._actionHandlers?._orderedActionHandlers?.MESSAGE_DELETE?.find?.(t=>t?.name=="MessageStore");)await new o.default.sleep(50);for(c.add((()=>{let t=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(e=>e.name=="MessageStore"),a=t.actionHandler,s=t.storeDidChange;return t.actionHandler=e=>{if(!p.persist.ghost.settings.antiDelete)return a.call(this,arg);!e?.id||!e?.author?.id||n.UserStore.getUser(e.author.id)?.bot||(d(e.id,!0).deleted=!0,setTimeout(()=>{o.default.ifExists(document.querySelector(`#chat-messages-${e?.id}`),u)},100))},t.storeDidChange=()=>{},()=>{i=[];let e=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(l=>l.name=="MessageStore");e.actionHandler=a,e.storeDidChange=s}})());!n.FluxDispatcher?._actionHandlers?._orderedActionHandlers?.MESSAGE_DELETE?.find?.(t=>t?.name=="MessageStore");)await new o.default.sleep(50);c.add((()=>{let t=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_UPDATE.find(e=>e.name=="MessageStore"),a=t.actionHandler,s=t.storeDidChange;return t.actionHandler=function(e){if(!p.persist.ghost.settings.antiEdit)return a.call(this,e);if(!e?.message?.id||!e?.message?.author?.id||n.UserStore.getUser(e.message.author.id)?.bot)return;if(e.message.content){let g=r(e.message.channel_id,e.message.id);if(g){let h=d(g.id,!0);h.edits.length||(h.content=g.content),h.content!=e.message.content&&h.edits.push(e.message.content)}}let l=a.call(this,e);return setTimeout(()=>{o.default.ifExists(document.querySelector(`#chat-messages-${e.message.id}`),u)},100),l},()=>{let e=n.FluxDispatcher._actionHandlers._orderedActionHandlers.MESSAGE_DELETE.find(l=>l.name=="MessageStore");e.actionHandler=a,e.storeDidChange=s}})())},unload(){c.removeAll()},settings:{data:[{type:"checkbox",name:"Anti-Delete",property:"antiDelete",value:!0},{type:"checkbox",name:"Anti-Edit",property:"antiEdit",value:!1}]}};return M})(acord.modules.common,acord.dom,acord.utils,acord.extension,acord.patcher);
